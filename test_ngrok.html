<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Gateway Test</title>

  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
</head>
<body>
  <h1>AI Gateway Dashboard</h1>
  <p>T·∫•t c·∫£ request ƒë∆∞·ª£c g·ª≠i t·ªõi Gateway (Ngrok Public URL)</p>

  <h2>1. NSFW Detection</h2>
  <form method="POST"
        action="https://zipppier-henry-bananas.ngrok-free.dev/analyze"
        enctype="multipart/form-data">
    <input type="file" name="image" accept="image/*" required />
    <button type="submit">Analyze NSFW</button>
  </form>

  <hr />

  <h2>2. Image Captioning</h2>
  <form method="POST"
        action="https://zipppier-henry-bananas.ngrok-free.dev/caption"
        enctype="multipart/form-data">
    <input type="file" name="image" accept="image/*" required />
    <button type="submit">Generate Caption</button>
  </form>

  <hr />

  <h2 style="color: #0d6efd;">3. Custom AI Description</h2>
  <p>Nh·∫≠p y√™u c·∫ßu ti·∫øng Vi·ªát, AI s·∫Ω tr·∫£ l·ªùi ti·∫øng Vi·ªát (Ch·∫°y qua Gateway -> Ollama).</p>
  
  <div>
    <label><b>Ch·ªçn ·∫£nh:</b></label> 
    <input type="file" id="customImg" accept="image/*" />
  </div>
  <br>
  <div>
    <label><b>Y√™u c·∫ßu (Prompt):</b></label><br>
    <textarea id="customPrompt" rows="3" cols="60" placeholder="V√≠ d·ª•: H√£y l√†m m·ªôt b√†i th∆° l·ª•c b√°t v·ªÅ b·ª©c ·∫£nh n√†y..."></textarea>
  </div>
  <br>
  <button id="btnCustom" style="padding: 8px 15px; background: #0d6efd; color: white; border: none; cursor: pointer;">G·ª≠i cho AI</button>
  
  <div id="customResult" style="margin-top: 10px; background: #f0f0f0; padding: 15px; border-radius: 5px; white-space: pre-line; display: none; border-left: 5px solid #0d6efd;"></div>

  <hr />

  <h2>4. Image ‚Üí 3D (Hunyuan3D)</h2>
  <input type="file" id="img3d" accept="image/*" />
  <button id="btn3d" style="padding: 8px 15px; background: #198754; color: white; border: none; cursor: pointer;">Generate 3D</button>

  <p id="status3d" style="font-weight: bold;"></p>

  <model-viewer id="viewer"
    style="width: 100%; max-width: 600px; height: 400px; border: 1px solid #ccc; background-color: #eee;"
    camera-controls
    auto-rotate
    exposure="1.0"
    environment-image="neutral">
  </model-viewer>

  <p>
    <a id="downloadGlb" href="#" download="model.glb" style="display:none; color: blue; text-decoration: underline;">
      Download GLB Model
    </a>
  </p>

  <script>
    // --- C·∫§U H√åNH URL ---
    // ƒê√¢y l√† ƒë·ªãa ch·ªâ Ngrok c·ªßa Gateway. N·∫øu b·∫°n t·∫Øt/b·∫≠t l·∫°i ngrok v√† c√≥ link m·ªõi, h√£y thay v√†o ƒë√¢y.
    const BASE_URL = "https://zipppier-henry-bananas.ngrok-free.dev/"; 

    // ======================================================
    // LOGIC CHO CUSTOM AI (G·ªçi Endpoint: /custom_describe)
    // ======================================================
    const btnCustom = document.getElementById('btnCustom');
    const customImgInput = document.getElementById('customImg');
    const customPromptInput = document.getElementById('customPrompt');
    const customResultBox = document.getElementById('customResult');

    btnCustom.onclick = async () => {
      const file = customImgInput.files[0];
      const promptText = customPromptInput.value;

      if (!file) {
        alert('Vui l√≤ng ch·ªçn ·∫£nh!');
        return;
      }

      // Hi·ªán tr·∫°ng th√°i Loading
      customResultBox.style.display = 'block';
      customResultBox.innerHTML = '‚è≥ <i>ƒêang x·ª≠ l√Ω... (Gateway ƒëang chuy·ªÉn y√™u c·∫ßu t·ªõi Ollama Service)...</i>';
      btnCustom.disabled = true;
      btnCustom.innerText = "ƒêang g·ª≠i...";

      const formData = new FormData();
      formData.append('image', file);
      formData.append('prompt', promptText);

      try {
        // G·ª≠i request t·ªõi Gateway
        const res = await fetch(`${BASE_URL}custom_describe`, {
          method: 'POST',
          body: formData
        });

        if (!res.ok) {
          throw new Error(`L·ªói Server Gateway: ${res.status}`);
        }

        const data = await res.json();
        
        if (data.error) {
           customResultBox.innerText = '‚ö†Ô∏è L·ªói t·ª´ Service: ' + data.error;
        } else {
           // Hi·ªÉn th·ªã k·∫øt qu·∫£ th√†nh c√¥ng
           customResultBox.innerHTML = `<b>ü§ñ AI Tr·∫£ l·ªùi:</b><br><br>${data.result}`;
        }

      } catch (err) {
        console.error(err);
        customResultBox.innerText = '‚ùå L·ªói k·∫øt n·ªëi: ' + err.message + '\n(H√£y ki·ªÉm tra xem Gateway v√† Ngrok c√≥ ƒëang ch·∫°y kh√¥ng)';
      } finally {
        btnCustom.disabled = false;
        btnCustom.innerText = "G·ª≠i cho AI";
      }
    };

    // ======================================================
    // LOGIC CHO 3D GENERATION (G·ªçi Endpoint: /generate3d)
    // ======================================================
    const btn3d = document.getElementById('btn3d');
    const fileInput3d = document.getElementById('img3d');
    const viewer = document.getElementById('viewer');
    const statusEl = document.getElementById('status3d');
    const downloadLink = document.getElementById('downloadGlb');

    btn3d.onclick = async () => {
      const file = fileInput3d.files[0];
      if (!file) {
        alert('Ch·ªçn m·ªôt ·∫£nh tr∆∞·ªõc ƒë√£');
        return;
      }

      statusEl.textContent = '‚è≥ ƒêang g·ª≠i ·∫£nh l√™n Gateway, vui l√≤ng ƒë·ª£i model 3D (kho·∫£ng 30s - 1 ph√∫t)...';
      statusEl.style.color = "blue";
      downloadLink.style.display = 'none';
      viewer.src = '';
      btn3d.disabled = true;

      const formData = new FormData();
      formData.append('image', file);

      try {
        const res = await fetch(`${BASE_URL}generate3d`, {
          method: 'POST',
          body: formData
        });

        if (!res.ok) {
          const text = await res.text();
          statusEl.textContent = '‚ùå L·ªói Gateway: ' + res.status + ' - ' + text;
          statusEl.style.color = "red";
          return;
        }

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);

        // Load GLB l√™n viewer
        viewer.src = url;

        // Cho ng∆∞·ªùi d√πng t·∫£i file xu·ªëng
        downloadLink.href = url;
        downloadLink.style.display = 'inline-block';

        statusEl.textContent = '‚úÖ Xong! (Done)';
        statusEl.style.color = "green";
      } catch (err) {
        console.error(err);
        statusEl.textContent = '‚ùå L·ªói request: ' + err;
        statusEl.style.color = "red";
      } finally {
        btn3d.disabled = false;
      }
    };
  </script>
</body>
</html>